generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  male
  female
  hidden
}

enum PracticeMode {
  drill
  quiz
  challenge
}

enum PomodoroStatus {
  in_progress
  completed
  failed
  abandoned
}

model User {
  id              String   @id @default(cuid())
  email           String?  @unique
  emailVerifiedAt DateTime?
  passwordHash    String?
  username        String?  @unique
  gender          Gender?  @default(hidden)
  age             Int?
  examStartDate   DateTime?
  aiProvider      String?
  aiModel         String?
  aiBaseUrl       String?
  aiApiKey        String?
  reminderHour    Int?
  reminderMinute  Int?
  walletAddress   String?  @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  sessions        Session[]
  aiAssistHistory AiAssistHistory[]
  aiChatMessages  AiChatMessage[]
  freeAiUsages    FreeAiUsage[]
  practiceSessions PracticeSession[]
  practiceRecords  PracticeRecord[]
  mistakes         Mistake[]
  studyTimeLogs    StudyTimeLog[]
  pomodoroSessions PomodoroSession[]
  pomodoroSubjects PomodoroSubject[]
  mockExamReports  MockExamReport[]
  knowledgeImports KnowledgeImport[]
  studyPlanProfile StudyPlanProfile?
  studyPlanHistories StudyPlanHistory[]
  studyPlanDailyTasks StudyPlanDailyTask[]
  klineReports      KlineReport[]
  expenseLogs       ExpenseLog[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  revokedAt DateTime?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  tokenHash String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
}

model AiAssistHistory {
  id         String   @id @default(cuid())
  userId     String
  scenarioId String
  question   String
  answer     String
  model      String?
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model AiChatMessage {
  id        String   @id @default(cuid())
  userId    String
  mode      String   @default("planner")
  role      String
  content   String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, mode, createdAt])
}

model FreeAiUsage {
  id        String   @id @default(cuid())
  userId    String
  date      DateTime
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model GlobalFreeAiUsage {
  id        String   @id @default(cuid())
  date      DateTime @unique
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date])
}

model PracticeSession {
  id              String       @id @default(cuid())
  userId          String
  practiceType    String
  categoryId      String?
  mode            PracticeMode
  totalQuestions  Int
  correctCount    Int
  accuracy        Float
  startedAt       DateTime
  endedAt         DateTime
  durationSeconds Int
  createdAt       DateTime     @default(now())
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  records         PracticeRecord[]
  mistakes        Mistake[]
  studyTimeLog    StudyTimeLog?

  @@index([userId, createdAt])
  @@index([userId, practiceType])
}

model PracticeRecord {
  id           String   @id @default(cuid())
  sessionId    String
  userId       String
  practiceType String
  categoryId   String?
  questionId   String
  prompt       String
  answer       String
  userAnswer   String
  correct      Boolean
  choices      Json?
  explanation  String?
  createdAt    DateTime @default(now())
  session      PracticeSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([sessionId])
}

model Mistake {
  id           String   @id @default(cuid())
  sessionId    String?
  userId       String
  practiceType String
  categoryId   String?
  questionId   String
  prompt       String
  answer       String
  userAnswer   String
  explanation  String?
  createdAt    DateTime @default(now())
  session      PracticeSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, categoryId])
}

model StudyTimeLog {
  id              String   @id @default(cuid())
  userId          String
  sessionId       String?  @unique
  startedAt       DateTime
  endedAt         DateTime?
  durationSeconds Int?
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  session         PracticeSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([userId, startedAt])
}

model PomodoroSession {
  id              String         @id @default(cuid())
  userId          String
  subject         String
  plannedMinutes  Int
  status          PomodoroStatus @default(in_progress)
  startedAt       DateTime
  endedAt         DateTime?
  durationSeconds Int?
  pauseSeconds    Int?
  pauseCount      Int?
  failureReason   String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startedAt])
  @@index([userId, subject])
  @@index([userId, status])
}

model PomodoroSubject {
  id        String   @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId, createdAt])
}

model MockExamReport {
  id              String   @id @default(cuid())
  userId          String
  title           String?
  note            String?
  metrics         Json?
  analysis        Json?
  analysisRaw     String?
  overallAccuracy Float?
  timeTotalMinutes Float?
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model KnowledgeImport {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  content   String
  source    String
  topics    Json?
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model StudyPlanProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique
  prepStartDate       DateTime?
  totalStudyHours     Float?
  totalStudyDurationText String?
  currentProgress     String?
  targetExam          String?
  targetExamDate      DateTime?
  plannedMaterials    String?
  interviewExperience Boolean?
  learningGoals       String?
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, updatedAt])
}

model StudyPlanHistory {
  id              String   @id @default(cuid())
  userId          String
  summary         String?
  progressUpdate  String?
  followUpAnswers String?
  profileSnapshot Json?
  preferences     Json?
  planData        Json?
  planRaw         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dailyTasks      StudyPlanDailyTask[]

  @@index([userId, createdAt])
}

model StudyPlanDailyTask {
  id            String   @id @default(cuid())
  userId        String
  planHistoryId String?
  date          DateTime
  summary       String?
  adjustNote    String?
  tasks         Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  planHistory   StudyPlanHistory? @relation(fields: [planHistoryId], references: [id], onDelete: SetNull)

  @@unique([userId, date])
  @@index([userId, date])
}

model KlineReport {
  id        String   @id @default(cuid())
  userId    String
  bazi      Json?
  input     Json?
  analysis  Json?
  raw       String?
  model     String?
  warning   String?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

model ExpenseLog {
  id         String   @id @default(cuid())
  userId     String
  item       String
  amount     Float
  occurredAt DateTime
  rawText    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, occurredAt])
  @@index([userId, createdAt])
}
